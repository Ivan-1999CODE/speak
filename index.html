<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å£èªªç·´ç¿’ç³»çµ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .rotate-y-180 {
            transform: rotateY(180deg);
        }
        .preserve-3d {
            transform-style: preserve-3d;
        }
        .backface-hidden {
            backface-visibility: hidden;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useRef, useEffect } = React;

        // --- å…§å»ºåœ–ç¤ºå…ƒä»¶ (æ›¿ä»£ lucide-react) ---
        const IconWrapper = ({ children, className, size = 24, onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>
                {children}
            </svg>
        );

        const Volume2 = (props) => (
            <IconWrapper {...props}>
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            </IconWrapper>
        );
        const Check = (props) => (
            <IconWrapper {...props}>
                <polyline points="20 6 9 17 4 12"></polyline>
            </IconWrapper>
        );
        const X = (props) => (
            <IconWrapper {...props}>
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </IconWrapper>
        );
        const Menu = (props) => (
            <IconWrapper {...props}>
                <line x1="4" y1="12" x2="20" y2="12"></line>
                <line x1="4" y1="6" x2="20" y2="6"></line>
                <line x1="4" y1="18" x2="20" y2="18"></line>
            </IconWrapper>
        );
        const Mic = (props) => (
            <IconWrapper {...props}>
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </IconWrapper>
        );
        const Loader2 = ({ className, size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`animate-spin ${className}`}>
                <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
            </svg>
        );
        // -------------------------------------------

        const App = () => {
          const chapters = [
            {
              id: 1,
              name: "ç¬¬ä¸€ç«  é€±æœ«/äº¤é€š/æ—…è¡Œæƒ…å¢ƒ",
              pairs: [
                {
                  q: "What are you going to do this weekend?",
                  qCh: "ä½ é€±æœ«æ‰“ç®—åšä»€éº¼?",
                  answers: [
                    { a: "I'm going to visit the night market.", aCh: "æˆ‘è¦å»é€›å¤œå¸‚ã€‚" },
                    { a: "I'm going to Taipei.", aCh: "æˆ‘è¦å»å°åŒ—ã€‚" }
                  ]
                },
                {
                  q: "Are you going to take a highway bus?",
                  qCh: "ä½ è¦æ­åœ‹é“å®¢é‹å—?",
                  answers: [
                    { a: "Yes, I am.", aCh: "æ˜¯çš„ï¼Œæˆ‘è¦æ­åœ‹é“å®¢é‹ã€‚" },
                    { a: "No, I am going to take a high speed rail.", aCh: "ä¸ï¼Œæˆ‘æœƒæ­é«˜éµã€‚" }
                  ]
                },
                {
                  q: "How much is the train ticket from Taichung to Taipei?",
                  qCh: "å°ä¸­åˆ°å°åŒ—çš„ç«è»Šç¥¨å¤šå°‘éŒ¢?",
                  answers: [
                    { a: "It is about $350 dollars.", aCh: "å¤§ç´„æ˜¯350å…ƒã€‚" }
                  ]
                },
                {
                  q: "What happened?",
                  qCh: "ç™¼ç”Ÿä»€éº¼äº‹äº†?",
                  answers: [
                    { a: "My flight was canceled.", aCh: "æˆ‘çš„ç­æ©Ÿè¢«å–æ¶ˆäº†ã€‚" },
                    { a: "My train was delayed.", aCh: "æˆ‘çš„ç«è»Šå»¶èª¤äº†ã€‚" }
                  ]
                },
                {
                  q: "How do I get there?",
                  qCh: "æˆ‘è¦æ€éº¼å»é‚£è£¡?",
                  answers: [
                    { a: "You can take the subway.", aCh: "ä½ å¯ä»¥æ­åœ°éµã€‚" },
                    { a: "Go straight and turn left/right.", aCh: "ç›´èµ°ç„¶å¾Œå·¦è½‰/å³è½‰ã€‚" }
                  ]
                },
              ]
            },
            {
              id: 2,
              name: "ç¬¬äºŒç«  é»é¤/è³¼ç‰©æƒ…å¢ƒ",
              pairs: [
                {
                  q: "How much is it?",
                  qCh: "é€™å€‹å¤šå°‘éŒ¢?",
                  answers: [
                    { a: "It's 20 dollars.", aCh: "20å…ƒã€‚" }
                  ]
                },
                {
                  q: "How much are they?",
                  qCh: "é€™äº›å¤šå°‘éŒ¢?",
                  answers: [
                    { a: "They're 50 dollars.", aCh: "50å…ƒã€‚" }
                  ]
                },
                {
                  q: "Where are you?",
                  qCh: "ä½ åœ¨å“ªè£¡?",
                  answers: [
                    { a: "I am in the restaurant.", aCh: "æˆ‘åœ¨é¤å»³ã€‚" }
                  ]
                },
                {
                  q: "May I take your order?",
                  qCh: "æˆ‘å¯ä»¥å¹«æ‚¨é»é¤å—?",
                  answers: [
                    { a: "I would like a hamburger, a salad.", aCh: "æˆ‘è¦ä¸€å€‹æ¼¢å ¡å’Œä¸€ä»½æ²™æ‹‰ã€‚" }
                  ]
                },
                {
                  q: "Anything else?",
                  qCh: "é‚„éœ€è¦å…¶ä»–çš„å—?",
                  answers: [
                    { a: "No. Thank you. That's all.", aCh: "ä¸ç”¨äº†ï¼Œè¬è¬ã€‚å°±é€™æ¨£ã€‚" },
                    { a: "I'll take some fries as well.", aCh: "æˆ‘é‚„è¦ä¸€äº›è–¯æ¢ã€‚" }
                  ]
                },
                {
                  q: "For here or to go?",
                  qCh: "å…§ç”¨é‚„æ˜¯å¤–å¸¶?",
                  answers: [
                    { a: "To go. Please.", aCh: "å¤–å¸¶ï¼Œè¬è¬ã€‚" },
                    { a: "For here, thanks.", aCh: "å…§ç”¨ï¼Œè¬è¬ã€‚" }
                  ]
                },
              ]
            },
            {
              id: 3,
              name: "Bonus-1 é£¯åº— / ä½å®¿",
              type: 'sentence_list',
              sentences: [
                { en: "I need to take a shower.", ch: "æˆ‘éœ€è¦æ´—æ¾¡ã€‚" },
                { en: "May I ask if those drinks in the fridge are free?", ch: "è«‹å•å†°ç®±è£¡çš„é£²æ–™æ˜¯å…è²»çš„å—ï¼Ÿ" }
              ]
            },
            {
              id: 4,
              name: "Bonus-2 é¤å»³ç”¨èª",
              type: 'sentence_list',
              sentences: [
                { en: "I feel like Thai food.", ch: "æˆ‘æƒ³åƒæ³°åœ‹èœã€‚" },
                { en: "Iâ€™d like to order something else.", ch: "æˆ‘æƒ³é»åˆ¥çš„æ±è¥¿ã€‚" },
                { en: "Whatâ€™s the name of the restaurant?", ch: "é€™å®¶é¤å»³çš„åå­—æ˜¯ä»€éº¼ï¼Ÿ" },
                { en: "Can I make a reservation?", ch: "æˆ‘å¯ä»¥é ç´„å—ï¼Ÿ" },
                { en: "I have a reservation.", ch: "æˆ‘æœ‰é ç´„ã€‚" },
                { en: "For two at 7 p.m. under the name Mr. Chen", ch: "é ç´„æ™šä¸Šä¸ƒé»å…©ä½ï¼Œåå­—æ˜¯é™³å…ˆç”Ÿ" },
                { en: "I prefer a window seat.", ch: "æˆ‘æ¯”è¼ƒå–œæ­¡é çª—åº§ä½ã€‚" },
                { en: "I prefer an aisle seat.", ch: "æˆ‘æ¯”è¼ƒå–œæ­¡é èµ°é“åº§ä½ã€‚" },
                { en: "Is this seat available?", ch: "é€™å€‹åº§ä½æœ‰äººå—ï¼Ÿ" },
                { en: "Do you prefer rice or noodles?", ch: "ä½ æ¯”è¼ƒå–œæ­¡é£¯é‚„æ˜¯éºµï¼Ÿ" },
                { en: "Which one do you recommend?", ch: "ä½ æ¨è–¦å“ªä¸€å€‹ï¼Ÿ" },
                { en: "Can I take a look?", ch: "æˆ‘å¯ä»¥çœ‹ä¸€ä¸‹å—ï¼Ÿ" }
              ]
            },
            {
              id: 5,
              name: "Bonus-3 å•è·¯ / äº¤é€š / è§€å…‰",
              type: 'sentence_list',
              sentences: [
                { en: "Do you know where a convenience store is?", ch: "ä½ çŸ¥é“ä¾¿åˆ©å•†åº—åœ¨å“ªè£¡å—ï¼Ÿ" },
                { en: "Could you show me where it is on the map?", ch: "ä½ å¯ä»¥åœ¨åœ°åœ–ä¸ŠæŒ‡çµ¦æˆ‘çœ‹å—ï¼Ÿ" },
                { en: "How long does it take?", ch: "è¦èŠ±å¤šä¹…æ™‚é–“ï¼Ÿ" },
                { en: "Do you have any souvenir recommendations?", ch: "ä½ æœ‰æ¨è–¦çš„ç´€å¿µå“å—ï¼Ÿ" },
                { en: "How do I get there?", ch: "æˆ‘è¦æ€éº¼å»é‚£è£¡ï¼Ÿ" }
              ]
            },
            {
              id: 6,
              name: "Bonus-4 çµå¸³èˆ‡å¸³å–®",
              type: 'sentence_list',
              sentences: [
                { en: "Can I get the check, please?", ch: "éº»ç…©è«‹çµ¦æˆ‘å¸³å–®ã€‚" },
                { en: "Can I have the bill, please?", ch: "éº»ç…©è«‹çµ¦æˆ‘å¸³å–®ã€‚" },
                { en: "Can I pay by credit card?", ch: "æˆ‘å¯ä»¥ç”¨ä¿¡ç”¨å¡ä»˜æ¬¾å—ï¼Ÿ" },
                { en: "Can I use Apple Pay?", ch: "æˆ‘å¯ä»¥ä½¿ç”¨ Apple Pay å—ï¼Ÿ" }
              ]
            },
            {
              id: 7,
              name: "Bonus-5 æéœ€æ±‚",
              type: 'sentence_list',
              sentences: [
                { en: "Can I get a pillow, please?", ch: "å¯ä»¥è«‹ä½ çµ¦æˆ‘ä¸€å€‹æ•é ­å—ï¼Ÿ" },
                { en: "Can you give me a blanket?", ch: "å¯ä»¥è«‹ä½ çµ¦æˆ‘ä¸€æ¢æ¯¯å­å—ï¼Ÿ" },
                { en: "Could you help me with my luggage?", ch: "å¯ä»¥è«‹ä½ å¹«æˆ‘æ‹¿è¡Œæå—ï¼Ÿ" },
                { en: "Can I have the Wi-Fi password?", ch: "å¯ä»¥çµ¦æˆ‘ Wi-Fi å¯†ç¢¼å—ï¼Ÿ" }
              ]
            }
          ];

          const [selectedChapters, setSelectedChapters] = useState([1, 2, 3, 4, 5, 6, 7]);
          const [activeTab, setActiveTab] = useState('practice');
          const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
          const [selectedAnswer, setSelectedAnswer] = useState(null);
          const [confirmedAnswer, setConfirmedAnswer] = useState(null);
          const [flippedCards, setFlippedCards] = useState(new Set());
          const [score, setScore] = useState({ correct: 0, total: 0 });
          const [bonusPracticeType, setBonusPracticeType] = useState('seeChinese_chooseEnglish');
          const [isSidebarOpen, setIsSidebarOpen] = useState(false);

          const [isListening, setIsListening] = useState(false);
          const [currentListeningIndex, setCurrentListeningIndex] = useState(null);
          const recognitionRef = useRef(null);

          // Function to shuffle an array (Fisher-Yates)
          const shuffleArray = (array) => {
            let currentIndex = array.length,  randomIndex;
            // While there remain elements to shuffle.
            while (currentIndex != 0) {
              // Pick a remaining element.
              randomIndex = Math.floor(Math.random() * currentIndex);
              currentIndex--;
              // And swap it with the current element.
              [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]];
            }
            return array;
          };

          const activePairs = useMemo(() => {
            const expandedPairs = [];
            chapters
              .filter(ch => selectedChapters.includes(ch.id))
              .forEach(ch => {
                if (ch.type === 'sentence_list') {
                    ch.sentences.forEach(sentence => {
                        expandedPairs.push({
                            q: sentence.en,
                            qCh: sentence.ch,
                            a: sentence.en, // The answer is the sentence itself for practice mode
                            aCh: sentence.ch,
                            type: 'sentence_list',
                            chapterId: ch.id 
                        });
                    });
                } else { // Existing logic for Q&A pairs
                    ch.pairs.forEach(pair => {
                      pair.answers.forEach(answer => {
                        expandedPairs.push({
                          q: pair.q,
                          qCh: pair.qCh,
                          a: answer.a,
                          aCh: answer.aCh,
                          type: 'qa',
                          chapterId: ch.id
                        });
                      });
                    });
                }
              });
            // Shuffle the expanded pairs
            return shuffleArray(expandedPairs);
          }, [selectedChapters]);

          const shuffledAnswers = useMemo(() => {
            if (activePairs.length === 0) return [];
            if (currentQuestionIndex >= activePairs.length) return []; 

            const correctAnswer = activePairs[currentQuestionIndex];
            const currentChapterId = correctAnswer.chapterId;

            // --- ç­–ç•¥ 1: å„ªå…ˆå¾ã€ŒåŒä¸€å€‹ç« ç¯€ã€æ‰¾ç­”æ¡ˆ ---
            let otherAnswers = activePairs.filter((pair, idx) => 
                idx !== currentQuestionIndex && 
                pair.a !== correctAnswer.a &&
                pair.chapterId === currentChapterId 
            );

            // éš¨æ©Ÿæ’åºä¸¦å– 2 å€‹
            let randomOthers = otherAnswers.sort(() => Math.random() - 0.5).slice(0, 2);

            // --- ç­–ç•¥ 2: å¦‚æœåŒç« ç¯€ä¸å¤  2 å€‹ç­”æ¡ˆï¼Œæ‰å¾ã€Œæ‰€æœ‰ç« ç¯€ã€è£œè¶³ ---
            if (randomOthers.length < 2) {
                const needed = 2 - randomOthers.length;

                // å¾ã€Œå…¶ä»–ç« ç¯€ã€æ‰¾ç­”æ¡ˆ
                const globalOtherAnswers = activePairs.filter((pair, idx) => 
                    idx !== currentQuestionIndex && 
                    pair.a !== correctAnswer.a &&
                    pair.chapterId !== currentChapterId && 
                    !randomOthers.some(oa => oa.a === pair.a) 
                );

                const globalRandom = globalOtherAnswers.sort(() => Math.random() - 0.5).slice(0, needed);
                
                randomOthers = [...randomOthers, ...globalRandom];
            }
            
            // --- ç­–ç•¥ 3: çµ•å°çš„å¾Œå‚™ ---
            if (randomOthers.length < 2) {
                 const absoluteNeeded = 2 - randomOthers.length;
                 const absoluteFallback = activePairs.filter((pair, idx) => 
                    idx !== currentQuestionIndex && 
                    pair.a !== correctAnswer.a &&
                    !randomOthers.some(oa => oa.a === pair.a) 
                 );
                 const absoluteRandom = absoluteFallback.sort(() => Math.random() - 0.5).slice(0, absoluteNeeded);
                 randomOthers = [...randomOthers, ...absoluteRandom];
            }

            const choices = [correctAnswer, ...randomOthers];

            let choiceIndex = 0;
            while (choices.length < 3 && activePairs.length > 0) {
                const padAnswer = activePairs[choiceIndex % activePairs.length];
                if (!choices.some(c => c.a === padAnswer.a)) {
                    choices.push(padAnswer);
                }
                choiceIndex++;
                if (choiceIndex > activePairs.length * 2) break; 
            }

            return choices.sort(() => Math.random() - 0.5);
          }, [currentQuestionIndex, activePairs]);

          const currentQuestion = activePairs.length > 0 ? activePairs[currentQuestionIndex] : null;

          // --- å£èªªæ¸¬é©— (Speaking Quiz) ç›¸é—œ state å’Œ å‡½å¼ ---

          const [speakingQuiz, setSpeakingQuiz] = useState({
            questions: [], 
            userAnswers: Array(5).fill(''), 
            feedback: Array(5).fill(''), 
            isLoading: false 
          });

          const startNewQuiz = React.useCallback(() => {
            let newQuestions = [];
            if (activePairs.length === 0) {
                setSpeakingQuiz({
                    questions: [],
                    userAnswers: Array(5).fill(''),
                    feedback: Array(5).fill(''),
                    isLoading: false
                 });
                 return;
            }
            
            newQuestions = shuffleArray([...activePairs]).slice(0, 5);

            if (newQuestions.length < 5 && newQuestions.length > 0) {
                const paddingNeeded = 5 - newQuestions.length;
                for(let i = 0; i < paddingNeeded; i++) {
                    newQuestions.push(newQuestions[i % newQuestions.length]); 
                }
            } else if (newQuestions.length === 0) {
                 newQuestions = Array(5).fill({ q: "æ²’æœ‰é¡Œç›®", qCh: "è«‹å…ˆé¸æ“‡ç« ç¯€", a: "", aCh: "" });
            }

            setSpeakingQuiz({
              questions: newQuestions,
              userAnswers: Array(5).fill(''),
              feedback: Array(5).fill(''),
              isLoading: false
            });
          }, [activePairs]);

          React.useEffect(() => {
            if (activePairs.length > 0) {
              startNewQuiz();
            }
          }, [activePairs, startNewQuiz]);

          // --- èªéŸ³è¾¨è­˜è¨­å®š (Web Speech API) ---
          useEffect(() => {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
              const recognition = new SpeechRecognition();
              recognition.continuous = false; 
              recognition.lang = 'en-US';      
              recognition.interimResults = false; 
              recognitionRef.current = recognition;
            } else {
              console.warn("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Speech API (èªéŸ³è¾¨è­˜)ã€‚");
            }

            return () => {
              if (recognitionRef.current) {
                recognitionRef.current.stop();
              }
            };
          }, []);

          const toggleListening = (index) => {
            if (!recognitionRef.current) {
              console.error("èªéŸ³è¾¨è­˜æœªåˆå§‹åŒ–æˆ–ä¸å—æ”¯æ´ã€‚");
              return;
            }

            const recognition = recognitionRef.current;

            if (isListening) {
              recognition.stop();
              setIsListening(false);
              setCurrentListeningIndex(null);
            } else {
              setCurrentListeningIndex(index);
              setIsListening(true);

              recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                
                setSpeakingQuiz(prev => {
                  const newAnswers = [...prev.userAnswers];
                  const currentAnswer = prev.userAnswers[index] || ''; 
                  const separator = currentAnswer.trim().length > 0 ? ' ' : ''; 
                  newAnswers[index] = currentAnswer + separator + transcript; 
                  return { ...prev, userAnswers: newAnswers };
                });
              };

              recognition.onend = () => {
                setIsListening(false);
                setCurrentListeningIndex(null);
              };

              recognition.onerror = (event) => {
                console.error("èªéŸ³è¾¨è­˜éŒ¯èª¤:", event.error);
                if (event.error === 'not-allowed') {
                  alert("éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•ã€‚è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚");
                }
                setIsListening(false);
                setCurrentListeningIndex(null);
              };

              try {
                recognition.start();
              } catch (e) {
                console.error("å•Ÿå‹•èªéŸ³è¾¨è­˜å¤±æ•—:", e);
                setIsListening(false);
                setCurrentListeningIndex(null);
              }
            }
          };

          const getAIFeedback = async (question, userAnswer) => {
            const systemPrompt = "ä½ æ˜¯ä½å‹å–„ã€é¼“å‹µå­¸ç”Ÿçš„è‹±æ–‡å®¶æ•™ã€‚ä½ çš„ä»»å‹™æ˜¯è©•ä¼°å­¸ç”Ÿçš„è‹±æ–‡å›ç­”ï¼Œä¸¦æä¾›å…·é«”çš„æ”¹é€²å»ºè­°ã€‚è«‹ç›¡é‡ç°¡æ½”ã€‚å°±ç®—å­¸ç”Ÿçš„ç­”æ¡ˆå¾ˆç°¡å–®ï¼Œä¹Ÿè¦é¼“å‹µä»–å€‘ä¸¦å»ºè­°ä¸€å€‹æ›´å®Œæ•´æˆ–æ›´è‡ªç„¶çš„èªªæ³•ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚ä½ çš„å›è¦†å¿…é ˆæ˜¯è‡ªç„¶çš„æ®µè½ï¼Œä¸è¦ä½¿ç”¨ä»»ä½•æ¨™é¡Œã€é …ç›®ç¬¦è™Ÿã€æ˜Ÿè™Ÿ(**)æˆ–äº•å­—è™Ÿ(###)ç­‰ markdown æ¨™è¨˜ã€‚";
            
            if (!userAnswer || userAnswer.trim() === '') {
              return `ä½ æ²’æœ‰å›ç­”å–”ï¼è©¦è‘—èªªèªªçœ‹ï¼šã€Œ${question.a}ã€`;
            }

            const questionPrompt = question.type === 'sentence_list'
              ? `ä¸­æ–‡æç¤º: "${question.qCh}"\n(æƒ…å¢ƒæ˜¯æ•´å¥ç¿»è­¯ï¼Œæ¨™æº–ç­”æ¡ˆæ˜¯ "${question.a}")`
              : `è‹±æ–‡å•é¡Œ: "${question.q}" (ä¸­æ–‡: ${question.qCh})\næ¨™æº–å›ç­”ç¯„ä¾‹: "${question.a}"`;
            
            const userQuery = `
              ${questionPrompt}
              å­¸ç”Ÿçš„å›ç­”: "${userAnswer}"

              è«‹è©•ä¼°å­¸ç”Ÿçš„å›ç­”ã€‚
              1.  å›è¦†è«‹ç›¡é‡ç°¡æ½”ã€‚
              2.  æä¾›ç°¡çŸ­ã€é¼“å‹µæ€§çš„æ„è¦‹ (ä¾‹å¦‚ï¼šèªªå¾—ä¸éŒ¯ï¼)ã€‚
              3.  å¦‚æœå­¸ç”Ÿçš„ç­”æ¡ˆæœ‰èª¤ï¼Œè«‹æº«å’Œåœ°ä¿®æ­£ï¼Œä¸¦èªªæ˜åŸå› ã€‚
              4.  å¦‚æœå­¸ç”Ÿçš„ç­”æ¡ˆå¤§è‡´æ­£ç¢ºï¼Œå¯ä»¥å»ºè­°ä¸€å€‹ã€Œæ›´è‡ªç„¶ä½†åŒæ¨£ç°¡å–®ã€çš„èªªæ³•ã€‚
              5.  æœ€å¾Œï¼Œè«‹æä¾›ä¸€å€‹ã€Œç°¡å–®ã€å®Œæ•´ä¸”æ­£ç¢ºã€çš„ç¯„ä¾‹èªªæ³•ï¼Œè®“å­¸ç”Ÿåƒè€ƒã€‚
              6.  (é‡è¦) ä¸è¦æä¾›å¤ªé›£æˆ–å¤ªé•·çš„å¥å­ï¼Œé€™äº›å­¸ç”Ÿæ˜¯åˆå­¸è€…ã€‚
              7.  (é‡è¦) è«‹ç”¨è‡ªç„¶çš„æ®µè½å›è¦†ï¼Œä¸è¦ä½¿ç”¨æ¨™é¡Œã€é …ç›®ç¬¦è™Ÿæˆ– markdown æ¨™è¨˜ (åƒæ˜¯ ### æˆ– **)ã€‚
            `;

            // âš ï¸âš ï¸âš ï¸ æ³¨æ„ï¼šè«‹åœ¨ä¸‹æ–¹å¼•è™Ÿä¸­å¡«å…¥æ‚¨çš„ API Key âš ï¸âš ï¸âš ï¸
            const apiKey = "AIzaSyBwORAUO3cNO-yzy9JSI7Lk2yqSULgRckM"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
              contents: [{ parts: [{ text: userQuery }] }],
              systemInstruction: {
                parts: [{ text: systemPrompt }]
              },
            };

            try {
              let response;
              for (let i = 0; i < 3; i++) {
                response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                });
                if (response.ok) break; 
                if (response.status === 429) { 
                      await new Promise(res => setTimeout(res, 1500 * (i + 1))); 
                } else if (response.status >= 500) { 
                    await new Promise(res => setTimeout(res, 1000 * (i + 1)));
                }
                else {
                    break; 
                }
              }

              if (!response.ok) {
                const errorBody = await response.text();
                console.error("API Error Response:", errorBody);
                throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
              }

              const result = await response.json();
              const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

              if (text) {
                return text;
              } else {
                console.warn("API response was successful but missing text content.", result);
                return "æŠ±æ­‰ï¼ŒAI åˆ†ææ™‚é‡åˆ°ä¸€é»å°å•é¡Œï¼Œå›å‚³çš„å…§å®¹æ˜¯ç©ºçš„ã€‚";
              }
            } catch (error) {
              console.error("Error getting AI feedback:", error);
              return `åˆ†æå¤±æ•—: ${error.message}ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚`;
            }
          };

          const handleQuizSubmit = async () => {
            setSpeakingQuiz(prev => ({ ...prev, isLoading: true, feedback: Array(5).fill('') }));
            
            const feedbackPromises = speakingQuiz.questions.map((q, i) => 
              getAIFeedback(q, speakingQuiz.userAnswers[i])
            );
            
            const results = await Promise.allSettled(feedbackPromises);
            
            const newFeedback = results.map(res => 
              res.status === 'fulfilled' ? res.value : `éŒ¯èª¤: ${res.reason?.message || 'æœªçŸ¥éŒ¯èª¤'}`
            );
            
            setSpeakingQuiz(prev => ({ ...prev, isLoading: false, feedback: newFeedback }));
          };

          const handleUserAnswerChange = (index, value) => {
            const newAnswers = [...speakingQuiz.userAnswers];
            newAnswers[index] = value;
            setSpeakingQuiz(prev => ({ ...prev, userAnswers: newAnswers }));
          };


          const speak = (text) => {
            if ('speechSynthesis' in window) {
              window.speechSynthesis.cancel(); 
              const utterance = new SpeechSynthesisUtterance(text);
              utterance.lang = 'en-US';

              const voices = window.speechSynthesis.getVoices();
              let selectedVoice = voices.find(voice => voice.name === 'Google US English');
              if (!selectedVoice) {
                  selectedVoice = voices.find(voice => voice.lang === 'en-US' && voice.name.toLowerCase().includes('female'));
              }
              if (!selectedVoice) {
                  selectedVoice = voices.find(voice => voice.lang === 'en-US' && voice.gender === 'female');
              }

              if (selectedVoice) {
                utterance.voice = selectedVoice;
              }

              window.speechSynthesis.speak(utterance);
            } else {
              console.error("Sorry, your browser doesn't support text-to-speech.");
            }
          };

          const toggleChapter = (chapterId) => {
            setSelectedChapters(prev =>
                prev.includes(chapterId)
                  ? prev.filter(id => id !== chapterId)
                : [...prev, chapterId]
            );
            setCurrentQuestionIndex(0);
            setSelectedAnswer(null);
            setConfirmedAnswer(null);
            setScore({ correct: 0, total: 0 });
            setFlippedCards(new Set());
            setSpeakingQuiz({
              questions: [],
              userAnswers: Array(5).fill(''),
              feedback: Array(5).fill(''),
              isLoading: false
            });
          };

          const toggleFlip = (cardId) => {
            setFlippedCards(prev => {
              const newSet = new Set(prev);
              if (newSet.has(cardId)) {
                newSet.delete(cardId);
              } else {
                newSet.add(cardId);
              }
              return newSet;
            });
          };

          const handleAnswerSelect = (answer) => {
            if (confirmedAnswer) return;
            setSelectedAnswer(answer);
          };

          const handleConfirm = () => {
            if (!selectedAnswer || confirmedAnswer) return;
                setConfirmedAnswer(selectedAnswer);
            const isCorrect = selectedAnswer.a === currentQuestion.a;
                if (isCorrect) {
              setScore(prev => ({ correct: prev.correct + 1, total: prev.total + 1 }));
            } else {
              setScore(prev => ({ ...prev, total: prev.total + 1 }));
            }
                setTimeout(() => {
              if (currentQuestionIndex < activePairs.length - 1) {
                setCurrentQuestionIndex(prev => prev + 1);
                setSelectedAnswer(null);
                setConfirmedAnswer(null);
                setFlippedCards(new Set());
              }
            }, 2000);
          };

          const Card = ({ content, translation, id, onClick, selected, isCorrect, isConfirmed, speakText, isSpeakable = true, textToSpeak }) => {
            const isFlipped = flippedCards.has(id);

            const handleSpeak = (e) => {
                e.stopPropagation(); 
                speakText(textToSpeak || content);
            };

                return (
              <div
                  className={`relative ${
                    selected ? 'ring-4 ring-blue-400 scale-105' : ''
                   } ${
                    isConfirmed !== null ? (isCorrect ? 'ring-4 ring-green-500' : isConfirmed ? 'ring-4 ring-red-500' : '') : ''
                   } w-64 h-40 sm:w-72 sm:h-48 cursor-pointer transition-all duration-300 flex items-center justify-center`}
                onClick={onClick}
              >
                <div className={`absolute inset-0 transition-transform duration-500 transform preserve-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                  {/* Front */}
                  <div className="absolute inset-0 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 flex items-center justify-center backface-hidden">
                    <p className="text-white text-center font-medium text-base sm:text-lg px-4 sm:px-8">{content}</p>
                    {isSpeakable &&
                      <button
                          onClick={handleSpeak}
                          className="absolute bottom-2 right-2 p-2 rounded-full bg-black bg-opacity-20 hover:bg-opacity-40 transition-colors z-20"
                          aria-label={`Speak: ${content}`}
                      >
                          <Volume2 className="text-white" size={18} />
                      </button>
                    }
                  </div>
                  {/* Back */}
                  <div className="absolute inset-0 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-4 sm:p-6 flex items-center justify-center rotate-y-180 backface-hidden">
                    <p className="text-white text-center font-medium text-base sm:text-lg">{translation}</p>
                  </div>
                </div>
                {isConfirmed !== null && (
                  <div className="absolute -top-2 -right-2 z-10">
                    {isCorrect ? (
                      <div className="bg-green-500 rounded-full p-2">
                        <Check className="text-white" size={20} />
                      </div>
                    ) : isConfirmed ? (
                      <div className="bg-red-500 rounded-full p-2">
                        <X className="text-white" size={20} />
                      </div>
                    ) : null}
                  </div>
                )}
              </div>
            );
          };

          if (activePairs.length === 0) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-indigo-100 to-purple-100 p-8 flex items-center justify-center">
                <div className="max-w-xl w-full">
                  <h1 className="text-3xl sm:text-4xl font-bold text-center mb-8 text-indigo-900">è‹±æ–‡å£èªªç·´ç¿’ç³»çµ±</h1>
                  <div className="bg-white rounded-lg shadow-xl p-4 sm:p-8">
                    <h2 className="text-2xl font-bold mb-4 text-gray-800">è«‹é¸æ“‡ç« ç¯€é–‹å§‹å­¸ç¿’</h2>
                    <div className="space-y-3">
                      {chapters.map(chapter => (
                        <label key={chapter.id} className="flex items-center space-x-3 p-3 sm:p-4 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
                          <input
                            type="checkbox"
                            checked={selectedChapters.includes(chapter.id)}
                            onChange={() => toggleChapter(chapter.id)}
                            className="w-5 h-5 text-blue-600 rounded focus:ring-blue-500"
                          />
                          <span className="text-base sm:text-lg font-medium text-gray-700">{chapter.name}</span>
                          <span className="ml-auto text-sm text-gray-500">
                              {chapter.type === 'sentence_list' ? `${chapter.sentences.length} å¥` : `${chapter.pairs.length} çµ„å°è©±`}
                          </span>
                        </label>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-indigo-100 to-purple-100">
              {/* Sidebar Overlay for mobile */}
              {isSidebarOpen && (
                <div
                    onClick={() => setIsSidebarOpen(false)}
                    className="md:hidden fixed inset-0 bg-black bg-opacity-50 z-20"
                    aria-hidden="true"
                ></div>
              )}
              
              {/* Sidebar */}
              <div className={`fixed left-0 top-0 h-full w-64 bg-white shadow-2xl p-6 overflow-y-auto z-30 transition-transform transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0`}>
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-bold text-indigo-900">ç« ç¯€é¸æ“‡</h2>
                    <button onClick={() => setIsSidebarOpen(false)} className="md:hidden p-1 text-gray-500 hover:text-gray-800">
                        <X className="h-6 w-6" />
                    </button>
                </div>
                <div className="space-y-3">
                  {chapters.map(chapter => (
                    <label key={chapter.id} className="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-indigo-50 cursor-pointer transition">
                      <input
                        type="checkbox"
                        checked={selectedChapters.includes(chapter.id)}
                        onChange={() => toggleChapter(chapter.id)}
                        className="w-5 h-5 text-indigo-600 mt-1 rounded focus:ring-indigo-500"
                      />
                      <div>
                        <span className="font-medium text-gray-800 block">{chapter.name}</span>
                        <span className="text-xs text-gray-500">
                          {chapter.type === 'sentence_list' ? `${chapter.sentences.length} å¥` : `${chapter.pairs.length} çµ„å°è©±`}
                        </span>
                      </div>
                    </label>
                  ))}
                </div>
                {activeTab === 'practice' && (
                  <div className="mt-8 p-4 bg-indigo-50 rounded-lg">
                    <h3 className="font-bold text-indigo-900 mb-2">å¾—åˆ†çµ±è¨ˆ</h3>
                    <p className="text-3xl font-bold text-indigo-600">{score.correct} / {score.total}</p>
                    <p className="text-sm text-gray-600">æ­£ç¢ºç‡: {score.total > 0 ? Math.round(score.correct / score.total * 100) : 0}%</p>
                  </div>
                )}
              </div>

              {/* Main Content */}
              <div className="md:ml-64 p-4 sm:p-8">
                {/* Hamburger Menu for Mobile */}
                <button
                    onClick={() => setIsSidebarOpen(true)}
                    className="md:hidden fixed top-4 left-4 z-10 p-2 bg-white rounded-full shadow-lg text-indigo-700"
                    aria-label="é–‹å•Ÿç« ç¯€é¸å–®"
                >
                    <Menu className="h-6 w-6" />
                </button>

                <h1 className="text-3xl sm:text-4xl font-bold text-center mb-8 text-indigo-900">è‹±æ–‡å£èªªç·´ç¿’ç³»çµ±</h1>
                
                    {/* Tab Navigation */}
                <div className="flex justify-center mb-8">
                  <div className="bg-white rounded-lg shadow-lg p-2 flex flex-col sm:flex-row gap-2">
                    <button
                      onClick={() => {
                        setActiveTab('learning');
                        setFlippedCards(new Set());
                      }}
                      className={`px-6 py-2 sm:px-8 sm:py-3 rounded-lg font-semibold transition-all ${
                        activeTab === 'learning'
                          ? 'bg-indigo-600 text-white shadow-md'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      ğŸ“š å­¸ç¿’æ¨¡å¼
                    </button>
                    <button
                      onClick={() => {
                        setActiveTab('practice');
                        setFlippedCards(new Set());
                        setSelectedAnswer(null);
                        setConfirmedAnswer(null);
                      }}
                      className={`px-6 py-2 sm:px-8 sm:py-3 rounded-lg font-semibold transition-all ${
                        activeTab === 'practice'
                          ? 'bg-indigo-600 text-white shadow-md'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      âœï¸ ç·´ç¿’æ¨¡å¼
                    </button>
                    <button
                      onClick={() => {
                        setActiveTab('speaking');
                        if (speakingQuiz.questions.length === 0 && activePairs.length > 0) {
                            startNewQuiz(); 
                        }
                      }}
                      className={`px-6 py-2 sm:px-8 sm:py-3 rounded-lg font-semibold transition-all ${
                        activeTab === 'speaking'
                          ? 'bg-indigo-600 text-white shadow-md'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      ğŸ—£ï¸ å£èªªæ¸¬é©—
                    </button>
                  </div>
                </div>

                <div className="max-w-6xl mx-auto">
                  {activeTab === 'learning' ? (
                    // Learning Mode
                    <div className="space-y-8">
                      {chapters.filter(ch => selectedChapters.includes(ch.id)).map(chapter => (
                        <div key={chapter.id} className="bg-white rounded-lg shadow-xl p-4 sm:p-8">
                          <h2 className="text-xl sm:text-2xl font-bold mb-6 text-indigo-800 border-b-2 border-indigo-200 pb-3">
                            {chapter.name}
                          </h2>
                          {chapter.type === 'sentence_list' ? (
                            <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
                              {chapter.sentences.map((sentence, sIdx) => (
                                <Card
                                  key={sIdx}
                                  content={sentence.en}
                                  translation={sentence.ch}
                                  id={`learn-sentence-${chapter.id}-${sIdx}`}
                                  onClick={() => toggleFlip(`learn-sentence-${chapter.id}-${sIdx}`)}
                                  speakText={speak}
                                />
                              ))}
                            </div>
                          ) : (
                            <div className="space-y-6">
                              {chapter.pairs.map((pair, idx) => (
                                <div key={idx} className="border-2 border-gray-200 rounded-lg p-4 sm:p-6 bg-gray-50">
                                  {pair.answers.length === 1 ? (
                                    <div className="grid md:grid-cols-2 gap-6 items-center">
                                      <div>
                                        <h3 className="text-xs sm:text-sm font-semibold mb-3 text-indigo-600">å•é¡Œ</h3>
                                        <Card
                                          content={pair.q}
                                          translation={pair.qCh}
                                          id={`learn-q-${chapter.id}-${idx}`}
                                          onClick={() => toggleFlip(`learn-q-${chapter.id}-${idx}`)}
                                          speakText={speak}
                                        />
                                      </div>
                                      <div>
                                        <h3 className="text-xs sm:text-sm font-semibold mb-3 text-green-600">å›ç­”</h3>
                                        <Card
                                          content={pair.answers[0].a}
                                          translation={pair.answers[0].aCh}
                                          id={`learn-a-${chapter.id}-${idx}-0`}
                                          onClick={() => toggleFlip(`learn-a-${chapter.id}-${idx}-0`)}
                                          speakText={speak}
                                        />
                                      </div>
                                    </div>
                                  ) : (
                                    <div className="space-y-6">
                                      <div>
                                        <h3 className="text-xs sm:text-sm font-semibold mb-3 text-indigo-600">å•é¡Œ</h3>
                                        <Card
                                          content={pair.q}
                                          translation={pair.qCh}
                                          id={`learn-q-${chapter.id}-${idx}`}
                                          onClick={() => toggleFlip(`learn-q-${chapter.id}-${idx}`)}
                                          speakText={speak}
                                        />
                                      </div>
                                      <div>
                                        <h3 className="text-xs sm:text-sm font-semibold mb-3 text-green-600">å›ç­”</h3>
                                        <div className="grid sm:grid-cols-2 gap-4">
                                          {pair.answers.map((answer, ansIdx) => (
                                            <Card
                                              key={ansIdx}
                                              content={answer.a}
                                              translation={answer.aCh}
                                              id={`learn-a-${chapter.id}-${idx}-${ansIdx}`}
                                              onClick={() => toggleFlip(`learn-a-${chapter.id}-${idx}-${ansIdx}`)}
                                              speakText={speak}
                                            />
                                          ))}
                                        </div>
                                      </div>
                                    </div>
                                  )}
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  ) : activeTab === 'practice' ? (
                    // Practice Mode
                    <div className="bg-white rounded-lg shadow-xl p-4 sm:p-8 mb-6">
                      <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl sm:text-2xl font-bold text-gray-800">ç·´ç¿’æ¨¡å¼</h2>
                        <span className="text-base sm:text-lg text-gray-600">ç¬¬ {currentQuestionIndex + 1} / {activePairs.length} é¡Œ</span>
                      </div>

                      {/* Bonus Practice Type Selector */}
                      {currentQuestion?.type === 'sentence_list' && (
                        <div className="flex justify-center items-center mb-6 p-3 bg-indigo-50 rounded-lg space-x-2 sm:space-x-4">
                          <span className="font-semibold text-gray-700 text-sm sm:text-base hidden sm:block">Bonus ç·´ç¿’æ–¹å¼:</span>
                          <button onClick={() => setBonusPracticeType('seeChinese_chooseEnglish')} className={`px-3 sm:px-4 py-2 rounded-lg text-sm font-semibold transition-all ${bonusPracticeType === 'seeChinese_chooseEnglish' ? 'bg-indigo-600 text-white shadow' : 'bg-white text-gray-600 hover:bg-gray-100'}`}>
                            çœ‹ä¸­é¸è‹±
                          </button>
                          <button onClick={() => setBonusPracticeType('listenEnglish_chooseChinese')} className={`px-3 sm:px-4 py-2 rounded-lg text-sm font-semibold transition-all ${bonusPracticeType === 'listenEnglish_chooseChinese' ? 'bg-indigo-600 text-white shadow' : 'bg-white text-gray-600 hover:bg-gray-100'}`}>
                            è½è‹±é¸ä¸­
                          </button>
                        </div>
                      )}

                      {/* Question Card */}
                      <div className="flex justify-center mb-8">
                        <div>
                          <h3 className="text-lg sm:text-xl font-semibold mb-4 text-center text-indigo-700">
                             {currentQuestion?.type === 'sentence_list' && bonusPracticeType === 'seeChinese_chooseEnglish'
                              ? "å•é¡Œ (çœ‹ä¸­æ–‡é¸è‹±æ–‡)"
                              : currentQuestion?.type === 'sentence_list' && bonusPracticeType === 'listenEnglish_chooseChinese'
                              ? "å•é¡Œ (è½è‹±æ–‡é¸ä¸­æ–‡)"
                              : "å•é¡Œ (é»æ“Šç¿»é¢çœ‹ä¸­æ–‡)"}
                          </h3>
                          <Card
                            content={
                              currentQuestion?.type === 'sentence_list' && bonusPracticeType === 'seeChinese_chooseEnglish'
                                ? currentQuestion.qCh
                                : currentQuestion?.type === 'sentence_list' && bonusPracticeType === 'listenEnglish_chooseChinese'
                                ? "é»æ“Šå–‡å­åœ–ç¤ºè†è½"
                                : currentQuestion.q
                            }
                            translation={
                              currentQuestion?.type === 'sentence_list' && bonusPracticeType === 'seeChinese_chooseEnglish'
                                ? currentQuestion.q
                                : currentQuestion.qCh
                            }
                            id={`q-${currentQuestionIndex}`}
                            onClick={() => toggleFlip(`q-${currentQuestionIndex}`)}
                            speakText={speak}
                            textToSpeak={currentQuestion.q} 
                            isSpeakable={!(currentQuestion?.type === 'sentence_list' && bonusPracticeType === 'seeChinese_chooseEnglish')}
                          />
                        </div>
                      </div>
                      {/* Answer Cards */}
                      <div>
                        <h3 className="text-lg sm:text-xl font-semibold mb-4 text-center text-indigo-700">
                          {currentQuestion?.type === 'sentence_list' && bonusPracticeType === 'listenEnglish_chooseChinese'
                            ? "é¸æ“‡æ­£ç¢ºçš„ä¸­æ–‡ç¿»è­¯"
                            : "é¸æ“‡æ­£ç¢ºçš„å›ç­” (é»æ“Šå¡ç‰‡å¯ç¿»é¢çœ‹ä¸­æ–‡)"}
                        </h3>
                        <div className="grid md:grid-cols-3 gap-6 justify-items-center mb-6">
                          {shuffledAnswers.map((pair, idx) => (
                            <Card
                              key={idx}
                              content={
                                currentQuestion?.type === 'sentence_list' && bonusPracticeType === 'listenEnglish_chooseChinese'
                                ? pair.aCh
                                : pair.a
                              }
                              translation={
                                currentQuestion?.type === 'sentence_list' && bonusPracticeType === 'listenEnglish_chooseChinese'
                                ? pair.a
                                : pair.aCh
                              }
                              id={`a-${idx}`}
                              onClick={() => {
                                if (!confirmedAnswer) {
                                  if (selectedAnswer === pair) {
                                    toggleFlip(`a-${idx}`);
                                  } else {
                                    handleAnswerSelect(pair);
                                  }
                                }
                              }}
                              selected={selectedAnswer === pair}
                              isConfirmed={confirmedAnswer === pair ? true : null}
                              isCorrect={confirmedAnswer === pair && pair.a === currentQuestion.a}
                              speakText={speak}
                              textToSpeak={pair.a} 
                              isSpeakable={!(currentQuestion?.type === 'sentence_list' && bonusPracticeType === 'listenEnglish_chooseChinese')}
                            />
                          ))}
                        </div>
                                        
                        {/* Confirm Button */}
                        <div className="flex justify-center">
                          <button
                            onClick={handleConfirm}
                            disabled={!selectedAnswer || confirmedAnswer}
                            className={`px-8 py-3 rounded-lg font-semibold text-base sm:text-lg transition-all ${
                              selectedAnswer && !confirmedAnswer
                                ? 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg hover:shadow-xl'
                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                            }`}
                          >
                            ç¢ºå®šç­”æ¡ˆ
                          </button>
                        </div>
                      </div>
                      {currentQuestionIndex === activePairs.length - 1 && confirmedAnswer && (
                        <div className="mt-6 p-4 bg-green-100 rounded-lg text-center">
                          <p className="text-lg sm:text-xl font-bold text-green-800">ğŸ‰ æ­å–œå®Œæˆæ‰€æœ‰é¡Œç›®ï¼</p>
                          <p className="text-base sm:text-lg text-green-700 mt-2">æœ€çµ‚å¾—åˆ†: {score.correct} / {score.total}</p>
                        </div>
                      )}
                    </div>
                  ) : activeTab === 'speaking' ? (
                    // Speaking Mode
                    <div className="bg-white rounded-lg shadow-xl p-4 sm:p-8 mb-6">
                      <div className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <div>
                          <h2 className="text-xl sm:text-2xl font-bold text-gray-800">å£èªªæ¸¬é©— (æ¨¡æ“¬)</h2>
                          <p className="text-sm text-gray-600 mt-1">
                            ç”±æ–¼ç€è¦½å™¨é™åˆ¶ï¼Œè«‹åœ¨æ­¤è¼¸å…¥æ‚¨æœƒã€Œèªªã€å‡ºçš„è‹±æ–‡ç­”æ¡ˆï¼ŒAI å°‡æä¾›æ”¹é€²å»ºè­°ã€‚
                          </p>
                        </div>
                        <button
                          onClick={startNewQuiz}
                          disabled={speakingQuiz.isLoading}
                          className="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-semibold hover:bg-indigo-200 transition disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          æ›ä¸€çµ„é¡Œç›®
                        </button>
                      </div>

                      {(speakingQuiz.questions.length === 0 || activePairs.length === 0) ? (
                         <p className="text-center text-gray-500 py-10">è«‹å…ˆåœ¨å·¦å´ã€Œç« ç¯€é¸æ“‡ã€ä¸­å‹¾é¸æ‚¨æƒ³ç·´ç¿’çš„ç« ç¯€ã€‚</p>
                      ) : (
                        <div className="space-y-6">
                          {speakingQuiz.questions.map((q, index) => (
                            <div key={index} className="border border-gray-200 rounded-lg p-4 transition-all duration-300">
                              <p className="font-semibold text-gray-700 mb-3">ç¬¬ {index + 1} é¡Œ</p>
                              {/* Question Prompt */}
                              <div className="bg-gray-50 p-4 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                                 {q.type === 'sentence_list' ? (
                                   <div>
                                     <p className="text-sm font-bold text-red-600">è«‹ç¿»è­¯ä»¥ä¸‹ä¸­æ–‡ï¼š</p>
                                     <p className="text-lg font-medium text-gray-800 mt-1">{q.qCh}</p>
                                   </div>
                                 ) : (
                                   <div>
                                     <p className="text-sm font-bold text-blue-700">è«‹å›ç­”ä»¥ä¸‹å•é¡Œï¼š</p>
                                     <p className="text-lg font-medium text-gray-800 mt-1">{q.q}</p>
                                     <p className="text-sm text-gray-500">{q.qCh}</p>
                                   </div>
                                 )}
                                 <button
                                   onClick={() => speak(q.a)}
                                   className="flex-shrink-0 flex items-center gap-1 px-3 py-1 bg-white border border-gray-300 rounded-full text-sm text-gray-700 hover:bg-gray-100 transition"
                                   title={q.type === 'sentence_list' ? "è½è½çœ‹è‹±æ–‡" : "è½è½çœ‹åƒè€ƒç­”æ¡ˆ"}
                                 >
                                   <Volume2 size={16} /> {q.type === 'sentence_list' ? "è½è‹±æ–‡" : "è½ç­”æ¡ˆ"}
                                 </button>
                              </div>
                              
                              {/* User Input */}
                              <div className="mt-4">
                                <label htmlFor={`answer-${index}`} className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                                  <Mic size={16} className="text-blue-500" />
                                  è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„è‹±æ–‡å›ç­” (æˆ–ä½¿ç”¨éº¥å…‹é¢¨)ï¼š
                                </label>
                                <div className="flex items-center gap-2">
                                  <textarea
                                    id={`answer-${index}`}
                                    rows={2}
                                    className="w-full flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition disabled:bg-gray-100"
                                    placeholder="è«‹è¼¸å…¥æ‚¨æœƒ...èªªå‡ºçš„è‹±æ–‡"
                                    value={speakingQuiz.userAnswers[index]}
                                    onChange={(e) => handleUserAnswerChange(index, e.target.value)}
                                    disabled={speakingQuiz.isLoading}
                                  />
                                  <button
                                    type="button"
                                    onClick={() => toggleListening(index)}
                                    disabled={speakingQuiz.isLoading || (isListening && currentListeningIndex !== index)}
                                    className={`flex-shrink-0 p-3 rounded-lg text-white transition-all duration-200 ${
                                      isListening && currentListeningIndex === index
                                        ? 'bg-red-500 hover:bg-red-600 animate-pulse' 
                                        : 'bg-blue-500 hover:bg-blue-600' 
                                    } ${
                                      (speakingQuiz.isLoading || (isListening && currentListeningIndex !== index))
                                        ? 'opacity-50 cursor-not-allowed'
                                        : ''
                                    }`}
                                    title={isListening && currentListeningIndex === index ? "åœæ­¢éŒ„éŸ³" : "é–‹å§‹éŒ„éŸ³"}
                                  >
                                    {isListening && currentListeningIndex === index ? (
                                      <Loader2 className="animate-spin" size={20} />
                                    ) : (
                                      <Mic size={20} />
                                    )}
                                  </button>
                                </div>
                              </div>
                              
                              {/* Feedback */}
                              {speakingQuiz.isLoading && !speakingQuiz.feedback[index] && (
                                <div className="mt-4 p-4 bg-gray-50 rounded-lg flex items-center justify-center">
                                  <Loader2 className="animate-spin text-gray-400" size={24} />
                                  <p className="ml-2 text-gray-500">AI è€å¸«è©•åˆ†ä¸­...</p>
                                </div>
                              )}
                              {speakingQuiz.feedback[index] && (
                                <div className="mt-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                                  <h4 className="font-semibold text-indigo-800 mb-2">AI è€å¸«å»ºè­°ï¼š</h4>
                                  <p className="text-gray-800 whitespace-pre-wrap leading-relaxed">{speakingQuiz.feedback[index]}</p>
                                </div>
                              )}
                            </div>
                          ))}
                          
                          {/* Submit Button */}
                          <div className="flex justify-center mt-8">
                            <button
                              onClick={handleQuizSubmit}
                              disabled={speakingQuiz.isLoading || speakingQuiz.userAnswers.every(a => a === '')}
                              className="flex items-center justify-center gap-2 px-8 py-3 bg-blue-600 text-white rounded-lg font-semibold text-lg hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
                            >
                              {speakingQuiz.isLoading ? (
                                <>
                                  <Loader2 className="animate-spin" size={20} />
                                  æ‰¹æ”¹ä¸­...
                                </>
                              ) : (
                                "é€å‡ºæ‰¹æ”¹"
                              )}
                            </button>
                          </div>
                          
                        </div>
                      )}
                    </div>
                  ) : null}
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
